# Dotbot defaults
- defaults:
    link:
      relink: true
    shell:
      quiet: true

# Base Packages (as root)
- sudo:
    - shell:
        - description: Base packages
          command: >
            apt-get update &&
            apt-get install -y vim-nox fish powerline
        - description: Install latest yq
          command: >
            wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq &&
            chmod +x /usr/bin/yq

# Fish stuff
- create:
    - ~/.config/fish/conf.d
    - ~/.config/fish/completions

- shell:
    - description: Get Oh my fish installer
      command: >
        curl -L https://raw.githubusercontent.com/oh-my-fish/oh-my-fish/master/bin/install > /tmp/install
    - description: Install Oh my fish
      command: >
        [ -f ~/.config/fish/conf.d/omf.fish ] || fish /tmp/install --verbose --noninteractive

- link:
    ~/.config/fish/conf.d/powerline.fish:
      path: config/fish/conf.d/powerline.fish
    ~/.config/powerline/:
      path: config/powerline/

# Ansible
- link:
    ~/.config/fish/conf.d/ansible.fish:
      path: config/fish/conf.d/ansible.fish
      if: '[ -x "$(command -v ansible)" ]'

# Kubernetes
- shell:
    - description: Completion for kubectl
      command: >
        [ -x "$(command -v kubectl)" ] &&
        git clone https://github.com/evanlucas/fish-kubectl-completions ~/.config/fish/fish-kubectl-completions &&
        ln -s ~/.config/fish/fish-kubectl-completions/completions/kubectl.fish ~/.config/fish/completions/ || true
      
# Openstack
- shell:
    - description: Completion for Openstack
      command: >
        [ -x "$(command -v openstack)" ] && 
        pip3 install osc-fish-complete &&
        openstack complete --shell fish > ~/.config/fish/completions/openstack.fish

- link:
    ~/.config/fish/conf.d/openstack.fish:
      path: config/fish/conf.d/openstack.fish
      if: '[ -x "$(command -v openstack)" ]'
    ~/.config/fish/completions/ose.fish:
      path: config/fish/completions/ose.fish
      if: '[ -x "$(command -v openstack)" ]'

# Finalize
- link:
    ~/.bashrc:
      force: true
